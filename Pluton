import sys
import os
import re
from collections import Counter, defaultdict
from PyQt5.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QPushButton,
    QLabel, QFileDialog, QTextEdit, QHBoxLayout, QMessageBox
)
from PyQt5.QtCore import Qt, QThread, pyqtSignal, QObject
from PyQt5.QtGui import QPixmap, QImage, QPainter, QColor, QPen
from PyQt5.QtPrintSupport import QPrinter, QPrintDialog
from PyPDF2 import PdfReader, PdfWriter
import fitz  # PyMuPDF za preview
import pdfplumber

# ------------------ Debug funkcija i prozor ------------------
class DebugWindow(QWidget):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Debug Output")
        self.resize(600, 300)
        layout = QVBoxLayout()
        self.text_edit = QTextEdit()
        self.text_edit.setReadOnly(True)
        layout.addWidget(self.text_edit)
        self.setLayout(layout)

    def log(self, message):
        self.text_edit.append(message)
        self.text_edit.verticalScrollBar().setValue(
            self.text_edit.verticalScrollBar().maximum()
        )

debug_window = None
def debug_print(message):
    if debug_window:
        debug_window.log(message)

class DebugSignal(QObject):
    new_message = pyqtSignal(str)

debug_signal = DebugSignal()

# ---------------- PDF funkcije ------------------
def extract_sku_from_text(text):
    text = text.replace("\n", " ")
    pattern = r'\d+ - [A-Za-z0-9\-]+(?:, \d+ - [A-Za-z0-9\-]+)*'
    match = re.search(pattern, text)
    if not match:
        print(text)
        return None
    sku_block = match.group(0)
    parts = [p.strip() for p in sku_block.split(",") if p.strip()]
    normalized = ", ".join(sorted(parts))
    return normalized

def sort_pdf_pages_and_count_sku(input_path, crop_bottom=50):
    reader = PdfReader(input_path)
    pages_info = []

    with pdfplumber.open(input_path) as pdf:
        for i, page in enumerate(pdf.pages):
            bbox = (0, page.height - crop_bottom, page.width, page.height)
            text = page.within_bbox(bbox).extract_text() or ""
            sku = extract_sku_from_text(text)
            debug_signal.new_message.emit(f"Page {i+1} SKU: [{sku}]")
            pages_info.append({"index": i, "sku": sku or ""})

    sku_counter = Counter(p["sku"] for p in pages_info)
    pages_info.sort(key=lambda p: (sku_counter[p["sku"]], p["sku"]), reverse=True)

    writer = PdfWriter()
    for p in pages_info:
        writer.add_page(reader.pages[p["index"]])

    output_path = os.path.splitext(input_path)[0] + "_sorted.pdf"
    with open(output_path, "wb") as f:
        writer.write(f)

    return pages_info, output_path

# ---------------- Worker nit ------------------
class PDFWorker(QThread):
    finished = pyqtSignal(list, str)
    error = pyqtSignal(str)

    def __init__(self, file_path, crop_bottom):
        super().__init__()
        self.file_path = file_path
        self.crop_bottom = crop_bottom
        
    def run(self):
        try:
            pages_info, output_path = sort_pdf_pages_and_count_sku(
                self.file_path, self.crop_bottom
            )
            self.finished.emit(pages_info, output_path)
        except Exception as e:
            self.error.emit(str(e))


# ------------------ GUI ------------------
class PDFSorter(QWidget):
    def __init__(self):
        super().__init__()
        self.worker = None
        self.pages_info = []
        self.sorted_pdf_path = ""
        self.doc_name = ""
        self.pdf_path = None  # ‚ö° Spremamo odabrani PDF
        self.initUI()
        self.debug_win = debug_window

    def initUI(self):
        self.setWindowTitle("Sortiranje PDF in Pickup lista")
        self.resize(700, 650)

        main_layout = QVBoxLayout()

        # Status
        self.status = QLabel("Izberi PDF datoteko za sortiranje:")
        self.status.setAlignment(Qt.AlignCenter)
        main_layout.addWidget(self.status)

        # Odabir PDF dugme
        self.load_pdf_button = QPushButton("üìÇ Izberi PDF")
        self.load_pdf_button.clicked.connect(self.load_pdf)
        main_layout.addWidget(self.load_pdf_button)

        # Crop input
        crop_layout = QHBoxLayout()
        crop_label = QLabel("Capture:")
        self.crop_input = QTextEdit()
        self.crop_input.setFixedHeight(30)
        self.crop_input.setText("50")
        self.crop_input.textChanged.connect(self.update_preview)
        crop_layout.addWidget(crop_label)
        crop_layout.addWidget(self.crop_input)
        main_layout.addLayout(crop_layout)

        # PDF preview label
        self.preview_label = QLabel()
        self.preview_label.setAlignment(Qt.AlignCenter)
        main_layout.addWidget(self.preview_label)

        # Sort dugme
        self.sort_button = QPushButton("‚ö° Sortiraj PDF")
        self.sort_button.clicked.connect(self.start_sort)
        self.sort_button.setEnabled(False)  # aktivira se nakon odabira PDF
        main_layout.addWidget(self.sort_button)

        # Pickup lista HTML
        self.preview = QTextEdit()
        self.preview.setReadOnly(True)
        main_layout.addWidget(self.preview)

        # Print dugme
        self.print_pick_button = QPushButton("üñ®Ô∏è Natisni Pickup listo")
        self.print_pick_button.clicked.connect(self.print_pick_list)
        main_layout.addWidget(self.print_pick_button)

        # Linkovi
        link_layout = QHBoxLayout()
        link_layout.addStretch()
        self.link_label = QLabel()
        self.link_label.setText(
            '<a href="https://www.linkedin.com/in/ramotoric/">LinkedIn</a> | '
            '<a href="https://github.com/5H4">GitHub</a>'
        )
        self.link_label.setOpenExternalLinks(True)
        link_layout.addWidget(self.link_label)
        main_layout.addLayout(link_layout)

        self.setLayout(main_layout)

    # ------------------ Odabir PDF ------------------
    def load_pdf(self):
        file_path, _ = QFileDialog.getOpenFileName(
            self, "Izberi PDF", "", "PDF datoteke (*.pdf)"
        )
        if file_path:
            self.pdf_path = file_path
            self.doc_name = os.path.basename(file_path)
            self.sort_button.setEnabled(True)
            self.update_preview()  # odmah poka≈æi preview

    # ------------------ Preview update ------------------
    def update_preview(self):
        if not self.pdf_path:
            return
        try:
            crop_value = int(self.crop_input.toPlainText().strip())
        except ValueError:
            crop_value = 50
        self.add_pdf_preview(self.pdf_path, crop_value)

    # ------------------ PDF Preview ------------------
    def add_pdf_preview(self, file_path, crop_bottom):
        doc = fitz.open(file_path)
        page = doc.load_page(0)
        pix = page.get_pixmap()
        img_bytes = pix.tobytes("ppm")

        qimg = QImage.fromData(img_bytes)
        pixmap = QPixmap.fromImage(qimg)

        painter = QPainter(pixmap)
        pen = QPen(QColor(255, 0, 0))
        pen.setWidth(4)
        painter.setPen(pen)

        y = pixmap.height() - crop_bottom
        painter.drawLine(0, y, pixmap.width(), y)
        painter.end()

        self.preview_label.setPixmap(pixmap)
        self.preview_label.setFixedHeight(300)
        self.preview_label.setScaledContents(True)

    # ------------------ Start sorting ------------------
    def start_sort(self):
        if not self.pdf_path:
            return
        self.status.setText("‚è≥ Sortiram PDF... prosim poƒçakaj...")
        self.sort_button.setEnabled(False)
        try:
            crop_value = int(self.crop_input.toPlainText().strip())
        except ValueError:
            crop_value = 50
        self.worker = PDFWorker(self.pdf_path, crop_value)
        self.worker.finished.connect(self.on_sort_done)
        self.worker.error.connect(self.on_sort_error)
        self.worker.start()

    # ------------------ Sorting callbacks ------------------
    def on_sort_done(self, pages_info, sorted_pdf_path):
        self.pages_info = pages_info
        self.sorted_pdf_path = sorted_pdf_path
        self.status.setText(f"‚úÖ PDF sortiran in shranjen: {sorted_pdf_path}")
        self.sort_button.setEnabled(True)
        self.show_pick_list_html()

        reply = QMessageBox.question(
            self, "PDF Sortiran", "Ali ≈æelite natisniti sortirani PDF?",
            QMessageBox.Yes | QMessageBox.No, QMessageBox.No
        )
        if reply == QMessageBox.Yes:
            self.print_pdf_dialog(sorted_pdf_path)

    def on_sort_error(self, error_message):
        self.status.setText(f"‚ùå Napaka: {error_message}")
        self.sort_button.setEnabled(True)

    # ------------------ Pickup lista ------------------
    def show_pick_list_html(self):
        if not self.pages_info:
            return
        total_counts = defaultdict(int)
        for page in self.pages_info:
            sku_str = page["sku"]
            if not sku_str:
                continue
            for part in sku_str.split(","):
                match = re.match(r"(\d+)\s*-\s*([A-Z0-9]+)", part.strip())
                if match:
                    qty, sku = match.groups()
                    total_counts[sku] += int(qty)

        sorted_items = sorted(total_counts.items(), key=lambda x: x[1], reverse=True)

        html = f"<h2>Pickup lista za dokument: {self.doc_name}</h2>"
        html += """<table border="1" cellspacing="0" cellpadding="4">
        <tr style="background-color: #d3d3d3;">
        <th>≈†t.</th><th>SKU</th><th>Koliƒçina</th></tr>"""
        for i, (sku, qty) in enumerate(sorted_items, 1):
            html += f"<tr><td>{i}</td><td>{sku}</td><td>{qty}</td></tr>"
        html += "</table>"

        self.preview.setHtml(html)

    # ------------------ Print funkcije ------------------
    def print_pick_list(self):
        if self.preview.toPlainText().strip() == "":
            return
        printer = QPrinter()
        dialog = QPrintDialog(printer, self)
        if dialog.exec_() == QPrintDialog.Accepted:
            self.preview.print_(printer)
            self.status.setText("üñ®Ô∏è Pickup listo poslana na tiskalnik.")

    def print_pdf_dialog(self, pdf_path):
        try:
            printer = QPrinter()
            dialog = QPrintDialog(printer, self)
            if dialog.exec_() == QPrintDialog.Accepted:
                if sys.platform.startswith('linux'):
                    os.system(f"lp '{pdf_path}'")
                elif sys.platform == 'win32':
                    os.startfile(pdf_path, "print")
                elif sys.platform == 'darwin':
                    os.system(f"lp '{pdf_path}'")
                self.status.setText(f"üñ®Ô∏è PDF poslan na tiskalnik: {pdf_path}")
        except Exception as e:
            self.status.setText(f"‚ùå Napaka pri tiskanju PDF: {str(e)}")

    def moveEvent(self, event):
        if self.debug_win:
            self.debug_win.move(self.x() + self.width() + 10, self.y())
        super().moveEvent(event)


# ------------------ RUN ------------------
if __name__ == '__main__':
    app = QApplication(sys.argv)
    ex = PDFSorter()
    ex.show()

    debug_window = DebugWindow()
    debug_window.setWindowFlags(debug_window.windowFlags() | Qt.WindowStaysOnTopHint)
    debug_window.show()
    debug_window.raise_()
    debug_window.activateWindow()
    debug_window.move(ex.x() + ex.width() + 10, ex.y())

    debug_signal.new_message.connect(debug_window.log)
    ex.debug_win = debug_window

    sys.exit(app.exec_())
